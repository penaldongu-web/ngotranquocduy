<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì S∆° C√° Nh√¢n - Ng√¥ Tr·∫ßn Qu·ªëc Duy</title>
    <style>
        /* CSS cho giao di·ªán Cyber Dark/Neon Style */
        :root {
            --dark-bg: #0D0C1D; /* M√†u n·ªÅn r·∫•t t·ªëi (G·∫ßn nh∆∞ ƒëen) */
            --card-color: #1A1A2E; /* M√†u th·∫ª n·ªôi dung t·ªëi */
            --text-light: #F0F0F0; /* M√†u ch·ªØ s√°ng */
            --accent-primary: #FF33CC; /* Neon Pink/Magenta - M√†u nh·∫•n ch√≠nh */
            --accent-secondary: #00FFFF; /* Cyan/Aqua Blue - M√†u nh·∫•n ph·ª• */
            --font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        /* ƒê·ªãnh d·∫°ng c∆° b·∫£n cho to√†n b·ªô trang */
        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative; /* C·∫ßn cho pseudo-element */
            overflow: hidden; /* Tr√°nh thanh cu·ªôn khi n·ªÅn m·ªü r·ªông */
        }
        
        /* === HI·ªÜU ·ª®NG N·ªÄN ƒê·ªòNG CYBER PLASMA === */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            /* T·∫°o c√°c gradient kh·ªïng l·ªì ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng plasma */
            background: 
                radial-gradient(circle at 10% 20%, var(--accent-primary) 0%, transparent 15%),
                radial-gradient(circle at 70% 80%, var(--accent-secondary) 0%, transparent 15%),
                radial-gradient(circle at 50% 10%, rgba(255, 255, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 30% 90%, rgba(0, 0, 0, 0.5) 0%, transparent 20%);
            background-size: 200% 200%;
            z-index: -1; /* ƒê·∫£m b·∫£o n√≥ n·∫±m d∆∞·ªõi n·ªôi dung */
            animation: background-shift 20s infinite linear;
        }

        /* Keyframes cho hi·ªáu ·ª©ng n·ªÅn xoay v√† d·ªãch chuy·ªÉn */
        @keyframes background-shift {
            0% {
                transform: rotate(0deg) scale(1);
                background-position: 0% 0%;
            }
            50% {
                transform: rotate(180deg) scale(1.1);
                background-position: 100% 100%;
            }
            100% {
                transform: rotate(360deg) scale(1);
                background-position: 0% 0%;
            }
        }
        /* ======================================= */

        
        /* Wrapper ch·ª©a th·∫ª h·ªì s∆° v√† th·∫ª ph·∫£n h·ªìi */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            gap: 30px; /* Kho·∫£ng c√°ch gi·ªØa th·∫ª h·ªì s∆° v√† th·∫ª ph·∫£n h·ªìi */
            padding: 30px 0;
            width: 90%;
            max-width: 500px;
            z-index: 10; /* ƒê·∫£m b·∫£o n·∫±m tr√™n l·ªõp n·ªÅn ƒë·ªông */
            position: relative;
        }

        /* Kh·ªëi h·ªì s∆° ch√≠nh gi·ªØa (The Card) */
        .profile-card {
            width: 100%; 
            padding: 40px 30px;
            background-color: var(--card-color);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(255, 51, 204, 0.3); 
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            /* Hi·ªáu ·ª©ng ƒë·ªï b√≥ng chuy·ªÉn ƒë·ªông (Dynamic Neon Glow) */
            animation: pulse-shadow 4s infinite alternate;
        }

        /* Keyframes cho hi·ªáu ·ª©ng ƒë·ªï b√≥ng */
        @keyframes pulse-shadow {
            0% {
                box-shadow: 0 0 40px rgba(255, 51, 204, 0.3), 0 0 10px rgba(0, 255, 255, 0.1);
            }
            100% {
                box-shadow: 0 0 50px rgba(255, 51, 204, 0.5), 0 0 20px rgba(0, 255, 255, 0.4);
            }
        }

        /* Logo/·∫¢nh ƒë·∫°i di·ªán */
        .profile-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-secondary);
            margin-bottom: 20px;
            box-shadow: 0 0 15px var(--accent-secondary); /* Shadow t·ª´ m√†u xanh neon */
            transition: transform 0.3s ease-in-out;
            animation: pop-in 0.5s ease-out; /* Hi·ªáu ·ª©ng xu·∫•t hi·ªán */
        }

        .profile-card img:hover {
             transform: scale(1.05) rotate(3deg);
        }

        @keyframes pop-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* T√™n (Typing Effect) */
        h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 10px 0;
            color: white;
            text-transform: uppercase;
            text-shadow: 0 0 5px var(--accent-primary);
            overflow: hidden; 
            border-right: .15em solid var(--accent-primary); 
            white-space: nowrap; 
            letter-spacing: .1em; 
            width: 0; 
            margin-left: auto;
            margin-right: auto;
            /* TƒÉng t·ªëc ƒë·ªô g√µ ch·ªØ l√™n 1.5s (t·ª´ 2s) */
            animation: 
                typing 1.5s steps(20, end) forwards, 
                blink-caret .75s step-end infinite; 
        }

        /* Keyframes cho hi·ªáu ·ª©ng g√µ */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        /* Keyframes cho con tr·ªè nh·∫•p nh√°y */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--accent-primary); }
        }
        
        /* ƒê·∫∑t t√™n c√≥ ƒë·ªô r·ªông c·ªë ƒë·ªãnh ƒë·ªÉ typing effect ho·∫°t ƒë·ªông */
        .name-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Th√¥ng tin chi ti·∫øt (Ng√†y sinh, Tr∆∞·ªùng) */
        .details p {
            margin: 5px 0;
            font-size: 1em;
            color: var(--text-light);
            animation: fade-in 1s ease-out 1.5s forwards; /* Th·ªùi gian xu·∫•t hi·ªán m·ªõi */
            opacity: 0;
        }

        /* S·ªü th√≠ch */
        .hobbies {
            font-size: 1.1em;
            font-weight: 500;
            margin: 15px 0 25px;
            padding: 10px 0;
            border-top: 1px dashed rgba(255, 51, 204, 0.3);
            border-bottom: 1px dashed rgba(255, 51, 204, 0.3);
            color: var(--accent-primary);
            text-shadow: 0 0 3px rgba(255, 51, 204, 0.5);
            animation: fade-in 1s ease-out 2s forwards;
            opacity: 0;
        }

        /* Hi·ªáu ·ª©ng Fade In chung */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* M·ª•c ti√™u */
        .goals-section {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            animation: fade-in 1s ease-out 2.5s forwards;
            opacity: 0;
        }
        
        .goals-section h2 {
            font-size: 1.2em;
            color: var(--accent-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px var(--accent-secondary);
        }

        .goal-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .goal-badge {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 10px rgba(255, 51, 204, 0.5);
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .goal-badge:hover {
            background-color: var(--accent-primary);
            color: var(--dark-bg);
            border-color: white;
            box-shadow: 0 0 15px var(--accent-primary);
        }
        
        /* Hi·ªáu ·ª©ng khi nh·∫•n (t∆∞∆°ng t√°c JS) */
        .goal-badge.clicked {
            background-color: white !important;
            color: var(--dark-bg) !important;
            transform: scale(0.95);
            animation: goal-bounce 0.3s;
        }
        
        @keyframes goal-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.95); }
        }


        .goal-badge.dream-uni {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .goal-badge.dream-uni:hover {
            background-color: var(--accent-secondary);
            color: var(--dark-bg);
            border-color: white;
            box-shadow: 0 0 15px var(--accent-secondary);
        }

        /* N√∫t m·∫°ng x√£ h·ªôi */
        .social-button {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: var(--dark-bg);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(255, 51, 204, 0.4);
            text-transform: uppercase;
            animation: fade-in 1s ease-out 3s forwards;
            opacity: 0;
        }

        .social-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 25px rgba(0, 255, 255, 0.6);
        }

        /* === LLM ASSISTANT STYLES === */
        .llm-assistant-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid var(--accent-secondary);
            border-radius: 12px;
            background-color: var(--card-color);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            animation: fade-in 1s ease-out 3.5s forwards; /* Tr·ªÖ h∆°n 1 ch√∫t */
            opacity: 0;
            text-align: left;
        }

        .llm-assistant-section h2 {
            font-size: 1.2em;
            color: var(--accent-primary);
            margin-top: 0;
            margin-bottom: 15px;
            text-shadow: 0 0 5px var(--accent-primary);
            text-align: center;
            text-transform: uppercase;
        }

        #goalQuery {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--accent-primary);
            background-color: var(--dark-bg);
            color: var(--text-light);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-family);
            outline: none;
            resize: vertical;
            margin-bottom: 10px;
        }
        #goalQuery:focus {
             border-color: var(--accent-secondary);
            box-shadow: 0 0 5px var(--accent-secondary);
        }

        .ask-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: var(--dark-bg);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
        }
        
        .ask-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 51, 204, 0.6);
        }
        
        .ask-button:disabled {
            background: #444;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--dark-bg);
            border: 1px solid rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 50px;
            font-size: 0.9em;
            color: var(--text-light);
            word-wrap: break-word;
        }

        .placeholder-text {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }
        
        .loading-text {
            color: var(--accent-secondary);
            text-align: center;
            font-weight: 600;
        }

        .result-source {
            margin-top: 10px;
            border-top: 1px dashed rgba(0, 255, 255, 0.2);
            padding-top: 5px;
            font-size: 0.75em;
            color: #888;
        }

        .result-source a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }
        .result-source a:hover {
            color: var(--accent-secondary);
        }
        
        /* === PH·∫¶N PH·∫¢N H·ªíI (FEEDBACK) === */
        .feedback-card {
            background-color: var(--card-color);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.1);
            width: 100%;
            margin-top: 20px;
        }

        .feedback-card h2 {
            color: var(--accent-secondary);
            text-shadow: 0 0 5px var(--accent-secondary);
            font-size: 1.5em;
            margin: 0 0 15px 0;
            text-align: center;
            text-transform: uppercase;
        }

        .feedback-card input, .feedback-card textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 51, 204, 0.5);
            background-color: var(--dark-bg);
            color: var(--text-light);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-family);
            outline: none;
        }
        .feedback-card input:focus, .feedback-card textarea:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 5px var(--accent-secondary);
        }

        .feedback-card textarea {
            resize: vertical;
            min-height: 60px;
        }

        .feedback-card button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: var(--accent-secondary);
            color: var(--dark-bg);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-bottom: 15px;
        }

        .feedback-card button[type="submit"]:hover {
            background: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-primary);
        }

        .feedback-list-title {
            color: var(--accent-primary);
            text-shadow: 0 0 3px var(--accent-primary);
            font-size: 1.1em;
            margin: 20px 0 15px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 51, 204, 0.3);
            text-align: center;
        }

        #feedbackList {
            max-height: 250px;
            overflow-y: auto;
            padding: 0 5px;
        }
        
        /* Style cho t·ª´ng ph·∫£n h·ªìi */
        .comment-item {
            background-color: var(--dark-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
            border-left: 3px solid var(--accent-secondary);
            word-wrap: break-word; 
        }

        .comment-name {
            font-weight: 700;
            color: var(--accent-primary);
            margin: 0;
            font-size: 0.9em;
        }

        .comment-message {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--text-light);
        }

        .comment-time {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 5px;
            text-align: right;
        }
        
        #userIdDisplay {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 15px;
            text-align: center;
        }
        
        /* Media Query cho di ƒë·ªông */
        @media (max-width: 600px) {
            .profile-card, .feedback-card {
                padding: 25px 15px;
                margin: 0;
            }
            #main-wrapper {
                padding: 15px 0;
            }
        }

    </style>
    <!-- Th∆∞ vi·ªán Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>

    <div id="main-wrapper">
        <div class="profile-card">
            <!-- Logo Tr∆∞·ªùng -->
            <img src="uploaded:image_d1a85f.png-d13814bc-f6cf-49cb-bbe8-f4195e387567" alt="Logo Tr∆∞·ªùng THPT Tr·∫ßn Ph√∫"> 

            <!-- T√™n -->
            <div class="name-container">
                <h1>NG√î TR·∫¶N QU·ªêC DUY</h1>
            </div>

            <!-- Th√¥ng tin c∆° b·∫£n -->
            <div class="details">
                <p><strong>Ng√†y sinh:</strong> 04/09/2008 | <strong>Gi·ªõi t√≠nh:</strong> Nam</p>
                <p><strong>Tr∆∞·ªùng:</strong> THPT Tr·∫ßn Ph√∫, TP.HCM</p>
            </div>
            
            <!-- S·ªü th√≠ch -->
            <div class="hobbies">
                <i class="fas fa-video"></i> Xem phim & <i class="fas fa-music"></i> Nghe nh·∫°c
            </div>
            
            <!-- M·ª•c ti√™u -->
            <div class="goals-section">
                <h2>M·ª•c ti√™u H·ªçc t·∫≠p</h2>
                <div class="goal-badges">
                    <div class="goal-badge" data-goal="T·ªët nghi·ªáp gi·ªèi">
                        <i class="fas fa-medal"></i> T·ªët nghi·ªáp THPT lo·∫°i gi·ªèi
                    </div>
                    <div class="goal-badge dream-uni" data-goal="ƒê·∫≠u ƒê·∫°i h·ªçc">
                        <i class="fas fa-graduation-cap"></i> ƒê·∫≠u v√†o Tr∆∞·ªùng m∆° ∆∞·ªõc
                    </div>
                </div>
            </div>

            <!-- LLM Integration - Goal Assistant -->
            <div class="llm-assistant-section">
                <h2>‚ú® Tr·ª£ l√Ω M·ª•c ti√™u Gemini</h2>
                <textarea id="goalQuery" placeholder="V√≠ d·ª•: 'L√†m th·∫ø n√†o ƒë·ªÉ c·∫£i thi·ªán ƒëi·ªÉm m√¥n To√°n?' ho·∫∑c 'Ng√†nh IT c√≥ tri·ªÉn v·ªçng g√¨?'"></textarea>
                <button id="askGeminiBtn" class="ask-button">
                    <i class="fas fa-magic"></i> H·ªèi Gemini
                </button>
                <div id="geminiResult" class="result-box">
                    <p class="placeholder-text">Nh·∫≠n l·ªùi khuy√™n t·ª´ AI ƒë·ªÉ ƒë·∫°t ƒë∆∞·ª£c m·ª•c ti√™u h·ªçc t·∫≠p!</p>
                </div>
            </div>

            <!-- N√∫t Li√™n h·ªá -->
            <a href="https://www.facebook.com/share/1DH3a3shJy/" class="social-button" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-facebook-f"></i> K·∫æT N·ªêI V·ªöI M√åNH
            </a>
            
        </div>
        
        <!-- PH·∫¶N PH·∫¢N H·ªíI -->
        <div class="feedback-card">
            <h2><i class="fas fa-comment-dots"></i> S·ªï L∆∞u B√∫t</h2>
            <form id="feedbackForm">
                <input type="text" id="feedbackName" placeholder="T√™n c·ªßa b·∫°n (T√πy ch·ªçn)">
                <textarea id="feedbackMessage" placeholder="L·ªùi nh·∫Øn mu·ªën g·ª≠i (T·ªëi ƒëa 200 k√Ω t·ª±)..." required maxlength="200"></textarea>
                <button type="submit">G·ª≠i Ph·∫£n H·ªìi</button>
            </form>
            
            <h3 class="feedback-list-title">L·ªùi Nh·∫Øn M·ªõi Nh·∫•t</h3>
            <div id="feedbackList">
                <p style="text-align: center; color: #6c757d; font-size: 0.9em;">ƒêang k·∫øt n·ªëi v√† t·∫£i l·ªùi nh·∫Øn...</p>
            </div>
            <p id="userIdDisplay">ID Ng∆∞·ªùi D√πng: <span id="currentUserId">...</span></p>
        </div>
    </div>

    <!-- FIREBASE V√Ä JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Thi·∫øt l·∫≠p bi·∫øn to√†n c·ª•c
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Kh·ªüi t·∫°o Firebase
        if (firebaseConfig) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId = null;

            // DOM elements
            const feedbackForm = document.getElementById('feedbackForm');
            const feedbackList = document.getElementById('feedbackList');
            const userIdSpan = document.getElementById('currentUserId');

            // LLM API Configuration
            const apiKey = ""; 
            const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

            // DOM elements cho LLM
            const goalQueryInput = document.getElementById('goalQuery');
            const askGeminiBtn = document.getElementById('askGeminiBtn');
            const geminiResultDiv = document.getElementById('geminiResult');
            
            // H√†m ƒë·ªãnh d·∫°ng th·ªùi gian
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'V·ª´a g·ª≠i';
                const date = timestamp.toDate();
                return date.toLocaleString('vi-VN', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            };

            // H√†m k·∫øt n·ªëi v√† x·ª≠ l√Ω x√°c th·ª±c
            const setupAuthAndFirestore = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Tr∆∞·ªùng h·ª£p kh√¥ng c√≥ user, d√πng ID ng·∫´u nhi√™n cho m·ª•c ƒë√≠ch hi·ªÉn th·ªã
                        userId = crypto.randomUUID(); 
                    }
                    userIdSpan.textContent = userId;
                    
                    // Ch·ªâ kh·ªüi t·∫°o listener sau khi c√≥ userId
                    if (userId) {
                        setupFeedbackListener(db, appId);
                    }
                });
            };
            
            // Thi·∫øt l·∫≠p Listener theo th·ªùi gian th·ª±c (onSnapshot)
            const setupFeedbackListener = (db, appId) => {
                // ƒê∆∞·ªùng d·∫´n c√¥ng khai (public) ƒë·ªÉ m·ªçi ng∆∞·ªùi ƒë·ªÅu c√≥ th·ªÉ th·∫•y
                const feedbackCollectionRef = collection(db, `artifacts/${appId}/public/data/user_feedback`);
                // L∆ØU √ù: ƒê√É X√ìA orderBy() ƒë·ªÉ tr√°nh l·ªói ch·ªâ m·ª•c (index missing) theo h∆∞·ªõng d·∫´n.
                const q = query(feedbackCollectionRef); 

                onSnapshot(q, (snapshot) => {
                    let messages = [];
                    snapshot.docs.forEach(doc => {
                        messages.push(doc.data());
                    });
                    
                    // S·∫Øp x·∫øp trong b·ªô nh·ªõ (client-side) ƒë·ªÉ tr√°nh l·ªói index missing
                    messages.sort((a, b) => {
                        // ƒê·∫£m b·∫£o c√°c ƒë·ªëi t∆∞·ª£ng c√≥ timestamp tr∆∞·ªõc khi so s√°nh
                        const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timeB - timeA; // G·∫ßn nh·∫•t l√™n ƒë·∫ßu
                    });


                    feedbackList.innerHTML = ''; // X√≥a n·ªôi dung c≈©
                    if (messages.length === 0) {
                        feedbackList.innerHTML = `<p style="text-align: center; color: #6c757d; font-size: 0.9em;">Ch∆∞a c√≥ l·ªùi nh·∫Øn n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>`;
                        return;
                    }

                    messages.forEach(data => {
                        const item = document.createElement('div');
                        item.classList.add('comment-item');
                        
                        // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi g·ª≠i (ho·∫∑c ID) v√† n·ªôi dung
                        const displayName = data.name || `Kh√°ch ·∫©n danh (${data.senderId.substring(0, 5)}...)`;
                        const timeString = formatTimestamp(data.timestamp);

                        item.innerHTML = `
                            <p class="comment-name"><i class="fas fa-user-circle"></i> ${displayName}</p>
                            <p class="comment-message">${data.message}</p>
                            <p class="comment-time">${timeString}</p>
                        `;
                        feedbackList.appendChild(item);
                    });
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    feedbackList.innerHTML = `<p style="text-align: center; color: red;">L·ªói t·∫£i l·ªùi nh·∫Øn: ${error.code}</p>`;
                });
            };

            // X·ª≠ l√Ω G·ª≠i ph·∫£n h·ªìi
            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('feedbackName');
                const messageInput = document.getElementById('feedbackMessage');

                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (!message) return;

                const submitButton = feedbackForm.querySelector('button');
                submitButton.textContent = 'ƒêang g·ª≠i...';
                submitButton.disabled = true;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/user_feedback`), {
                        name: name.substring(0, 50) || null,
                        message: message.substring(0, 200),
                        timestamp: serverTimestamp(),
                        senderId: userId,
                    });

                    // X√≥a form sau khi g·ª≠i th√†nh c√¥ng
                    nameInput.value = '';
                    messageInput.value = '';

                } catch (e) {
                    console.error("Error adding document: ", e);
                } finally {
                    submitButton.textContent = 'G·ª≠i Ph·∫£n H·ªìi';
                    submitButton.disabled = false;
                }
            });

            // 1. Logic cho Goal Badge
            const goalBadges = document.querySelectorAll('.goal-badge');
            const originalGoal = document.querySelector('.goals-section h2').textContent;
            const goalsTitle = document.querySelector('.goals-section h2');

            goalBadges.forEach(badge => {
                badge.addEventListener('click', () => {
                    goalBadges.forEach(b => {
                        if (b !== badge) {
                            b.classList.remove('clicked');
                        }
                    });
                    badge.classList.toggle('clicked');
                    
                    if (badge.classList.contains('clicked')) {
                         goalsTitle.textContent = `üí™ ƒêang t·∫≠p trung v√†o: ${badge.dataset.goal}`;
                    } else {
                         goalsTitle.textContent = originalGoal;
                    }
                });
            });


            /**
             * Th·ª±c hi·ªán g·ªçi API Gemini v·ªõi logic retry (exponential backoff).
             * @param {Object} payload - Payload cho API.
             * @param {number} retries - S·ªë l·∫ßn th·ª≠ l·∫°i t·ªëi ƒëa.
             * @returns {Promise<Object>} K·∫øt qu·∫£ JSON t·ª´ API.
             */
            const callGeminiApiWithRetry = async (payload, retries = 5) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(`${LLM_API_URL}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            return await response.json();
                        } else if (response.status === 429) { 
                            // Qu√° gi·ªõi h·∫°n t·ªëc ƒë·ªô (Rate Limit)
                            if (i < retries - 1) {
                                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue; 
                            }
                            throw new Error("L·ªói gi·ªõi h·∫°n t·ªëc ƒë·ªô API sau nhi·ªÅu l·∫ßn th·ª≠.");
                        } else {
                            // L·ªói kh√°c
                            const errorBody = await response.text();
                            throw new Error(`L·ªói API: ${response.status} - ${errorBody}`);
                        }
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error; // N√©m l·ªói n·∫øu ƒë√£ th·ª≠ h·∫øt
                        }
                        // Retry logic (ƒë√£ x·ª≠ l√Ω ·ªü tr√™n)
                    }
                }
            };

            // X·ª≠ l√Ω n√∫t H·ªèi Gemini
            askGeminiBtn.addEventListener('click', async () => {
                const query = goalQueryInput.value.trim();
                if (!query) {
                    geminiResultDiv.innerHTML = `<p class="placeholder-text">Vui l√≤ng nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n.</p>`;
                    return;
                }

                askGeminiBtn.disabled = true;
                askGeminiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...';
                geminiResultDiv.innerHTML = `<p class="loading-text">Gemini ƒëang t√¨m ki·∫øm l·ªùi khuy√™n t·ªët nh·∫•t...</p>`;

                const systemPrompt = "B·∫°n l√† m·ªôt c·ªë v·∫•n h·ªçc t·∫≠p v√† h∆∞·ªõng nghi·ªáp th√¢n thi·ªán, nhi·ªát t√¨nh ·ªü Vi·ªát Nam. H√£y ƒë∆∞a ra c√¢u tr·∫£ l·ªùi ng·∫Øn g·ªçn (d∆∞·ªõi 150 t·ª´), tr·ª±c ti·∫øp, v√† d·ª±a tr√™n th√¥ng tin th·ª±c t·∫ø cho h·ªçc sinh c·∫•p 3. S·ª≠ d·ª•ng ti·∫øng Vi·ªát chu·∫©n.";

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    // K√≠ch ho·∫°t Google Search ƒë·ªÉ c√≥ th√¥ng tin c·∫≠p nh·∫≠t (v·ªÅ tr∆∞·ªùng, ng√†nh, ƒëi·ªÉm s·ªë)
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const result = await callGeminiApiWithRetry(payload);
                    const candidate = result.candidates?.[0];
                    let text = "Kh√¥ng th·ªÉ t√¨m th·∫•y c√¢u tr·∫£ l·ªùi ph√π h·ª£p. Vui l√≤ng th·ª≠ l·∫°i.";
                    let sourcesHtml = "";
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        text = candidate.content.parts[0].text;

                        // X·ª≠ l√Ω tr√≠ch d·∫´n ngu·ªìn (citations)
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                sourcesHtml = '<div class="result-source">Ngu·ªìn tham kh·∫£o:';
                                sources.slice(0, 3).forEach((source, index) => { // Ch·ªâ l·∫•y 3 ngu·ªìn ƒë·∫ßu
                                    sourcesHtml += `<br><a href="${source.uri}" target="_blank" rel="noopener noreferrer">${index + 1}. ${source.title.substring(0, 50)}...</a>`;
                                });
                                sourcesHtml += '</div>';
                            }
                        }
                    }

                    geminiResultDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>${sourcesHtml}`;

                } catch (error) {
                    console.error("L·ªói Gemini API:", error);
                    geminiResultDiv.innerHTML = `<p style="color: var(--accent-primary); text-align: center;">L·ªói k·∫øt n·ªëi. Vui l√≤ng ki·ªÉm tra console ho·∫∑c th·ª≠ l·∫°i.</p>`;
                } finally {
                    askGeminiBtn.disabled = false;
                    askGeminiBtn.innerHTML = '<i class="fas fa-magic"></i> H·ªèi Gemini';
                }
            });


            // B·∫Øt ƒë·∫ßu qu√° tr√¨nh x√°c th·ª±c v√† t·∫£i d·ªØ li·ªáu
            setupAuthAndFirestore();

        } else {
            console.error("Firebase config is missing!");
            document.getElementById('feedbackList').innerHTML = '<p style="text-align: center; color: red;">L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi d·ªãch v·ª• l∆∞u tr·ªØ.</p>';
        }

    </script>
</body>
</html>
