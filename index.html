<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hồ Sơ Cá Nhân - Ngô Trần Quốc Duy</title>
    <style>
        /* CSS cho giao diện Cyber Dark/Neon Style */
        :root {
            --dark-bg: #0D0C1D; /* Màu nền rất tối (Gần như đen) */
            --card-color: #1A1A2E; /* Màu thẻ nội dung tối */
            --text-light: #F0F0F0; /* Màu chữ sáng */
            --accent-primary: #FF33CC; /* Neon Pink/Magenta - Màu nhấn chính */
            --accent-secondary: #00FFFF; /* Cyan/Aqua Blue - Màu nhấn phụ */
            --font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        /* Định dạng cơ bản cho toàn bộ trang */
        body {
            font-family: var(--font-family);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: var(--dark-bg);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative; /* Cần cho pseudo-element */
            overflow: hidden; /* Tránh thanh cuộn khi nền mở rộng */
        }
        
        /* === HIỆU ỨNG NỀN ĐỘNG CYBER PLASMA === */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            /* Tạo các gradient khổng lồ để tạo hiệu ứng plasma */
            background: 
                radial-gradient(circle at 10% 20%, var(--accent-primary) 0%, transparent 15%),
                radial-gradient(circle at 70% 80%, var(--accent-secondary) 0%, transparent 15%),
                radial-gradient(circle at 50% 10%, rgba(255, 255, 255, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 30% 90%, rgba(0, 0, 0, 0.5) 0%, transparent 20%);
            background-size: 200% 200%;
            z-index: -1; /* Đảm bảo nó nằm dưới nội dung */
            animation: background-shift 20s infinite linear;
        }

        /* Keyframes cho hiệu ứng nền xoay và dịch chuyển */
        @keyframes background-shift {
            0% {
                transform: rotate(0deg) scale(1);
                background-position: 0% 0%;
            }
            50% {
                transform: rotate(180deg) scale(1.1);
                background-position: 100% 100%;
            }
            100% {
                transform: rotate(360deg) scale(1);
                background-position: 0% 0%;
            }
        }
        /* ======================================= */

        
        /* Wrapper chứa thẻ hồ sơ và thẻ phản hồi */
        #main-wrapper {
            display: flex;
            flex-direction: column;
            gap: 30px; /* Khoảng cách giữa thẻ hồ sơ và thẻ phản hồi */
            padding: 30px 0;
            width: 90%;
            max-width: 500px;
            z-index: 10; /* Đảm bảo nằm trên lớp nền động */
            position: relative;
        }

        /* Khối hồ sơ chính giữa (The Card) */
        .profile-card {
            width: 100%; 
            padding: 40px 30px;
            background-color: var(--card-color);
            border-radius: 16px;
            box-shadow: 0 0 40px rgba(255, 51, 204, 0.3); 
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            /* Hiệu ứng đổ bóng chuyển động (Dynamic Neon Glow) */
            animation: pulse-shadow 4s infinite alternate;
        }

        /* Keyframes cho hiệu ứng đổ bóng */
        @keyframes pulse-shadow {
            0% {
                box-shadow: 0 0 40px rgba(255, 51, 204, 0.3), 0 0 10px rgba(0, 255, 255, 0.1);
            }
            100% {
                box-shadow: 0 0 50px rgba(255, 51, 204, 0.5), 0 0 20px rgba(0, 255, 255, 0.4);
            }
        }

        /* Logo/Ảnh đại diện */
        .profile-card img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent-secondary);
            margin-bottom: 20px;
            box-shadow: 0 0 15px var(--accent-secondary); /* Shadow từ màu xanh neon */
            transition: transform 0.3s ease-in-out;
            animation: pop-in 0.5s ease-out; /* Hiệu ứng xuất hiện */
        }

        .profile-card img:hover {
             transform: scale(1.05) rotate(3deg);
        }

        @keyframes pop-in {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Tên (Typing Effect) */
        h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 10px 0;
            color: white;
            text-transform: uppercase;
            text-shadow: 0 0 5px var(--accent-primary);
            overflow: hidden; 
            border-right: .15em solid var(--accent-primary); 
            white-space: nowrap; 
            letter-spacing: .1em; 
            width: 0; 
            margin-left: auto;
            margin-right: auto;
            /* Tăng tốc độ gõ chữ lên 1.5s (từ 2s) */
            animation: 
                typing 1.5s steps(20, end) forwards, 
                blink-caret .75s step-end infinite; 
        }

        /* Keyframes cho hiệu ứng gõ */
        @keyframes typing {
            from { width: 0 }
            to { width: 100% }
        }

        /* Keyframes cho con trỏ nhấp nháy */
        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: var(--accent-primary); }
        }
        
        /* Đặt tên có độ rộng cố định để typing effect hoạt động */
        .name-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }

        /* Thông tin chi tiết (Ngày sinh, Trường) */
        .details p {
            margin: 5px 0;
            font-size: 1em;
            color: var(--text-light);
            animation: fade-in 1s ease-out 1.5s forwards; /* Thời gian xuất hiện mới */
            opacity: 0;
        }

        /* Sở thích */
        .hobbies {
            font-size: 1.1em;
            font-weight: 500;
            margin: 15px 0 25px;
            padding: 10px 0;
            border-top: 1px dashed rgba(255, 51, 204, 0.3);
            border-bottom: 1px dashed rgba(255, 51, 204, 0.3);
            color: var(--accent-primary);
            text-shadow: 0 0 3px rgba(255, 51, 204, 0.5);
            animation: fade-in 1s ease-out 2s forwards;
            opacity: 0;
        }

        /* Hiệu ứng Fade In chung */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mục tiêu */
        .goals-section {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid rgba(0, 255, 255, 0.2);
            animation: fade-in 1s ease-out 2.5s forwards;
            opacity: 0;
        }
        
        .goals-section h2 {
            font-size: 1.2em;
            color: var(--accent-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 0 5px var(--accent-secondary);
        }

        .goal-badges {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .goal-badge {
            background-color: var(--dark-bg);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95em;
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 10px rgba(255, 51, 204, 0.5);
            cursor: pointer; 
            transition: all 0.2s;
        }
        
        .goal-badge:hover {
            background-color: var(--accent-primary);
            color: var(--dark-bg);
            border-color: white;
            box-shadow: 0 0 15px var(--accent-primary);
        }
        
        /* Hiệu ứng khi nhấn (tương tác JS) */
        .goal-badge.clicked {
            background-color: white !important;
            color: var(--dark-bg) !important;
            transform: scale(0.95);
            animation: goal-bounce 0.3s;
        }
        
        @keyframes goal-bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(0.95); }
        }


        .goal-badge.dream-uni {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .goal-badge.dream-uni:hover {
            background-color: var(--accent-secondary);
            color: var(--dark-bg);
            border-color: white;
            box-shadow: 0 0 15px var(--accent-secondary);
        }

        /* Nút mạng xã hội */
        .social-button {
            display: inline-block;
            margin-top: 30px;
            padding: 12px 25px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: var(--dark-bg);
            text-decoration: none;
            border-radius: 8px;
            font-weight: 700;
            transition: background 0.3s, transform 0.1s;
            box-shadow: 0 4px 20px rgba(255, 51, 204, 0.4);
            text-transform: uppercase;
            animation: fade-in 1s ease-out 3s forwards;
            opacity: 0;
        }

        .social-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 25px rgba(0, 255, 255, 0.6);
        }

        /* === LLM ASSISTANT STYLES === */
        .llm-assistant-section {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid var(--accent-secondary);
            border-radius: 12px;
            background-color: var(--card-color);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
            animation: fade-in 1s ease-out 3.5s forwards; /* Trễ hơn 1 chút */
            opacity: 0;
            text-align: left;
        }

        .llm-assistant-section h2 {
            font-size: 1.2em;
            color: var(--accent-primary);
            margin-top: 0;
            margin-bottom: 15px;
            text-shadow: 0 0 5px var(--accent-primary);
            text-align: center;
            text-transform: uppercase;
        }

        #goalQuery {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid var(--accent-primary);
            background-color: var(--dark-bg);
            color: var(--text-light);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-family);
            outline: none;
            resize: vertical;
            margin-bottom: 10px;
        }
        #goalQuery:focus {
             border-color: var(--accent-secondary);
            box-shadow: 0 0 5px var(--accent-secondary);
        }

        .ask-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            color: var(--dark-bg);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            text-transform: uppercase;
        }
        
        .ask-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 51, 204, 0.6);
        }
        
        .ask-button:disabled {
            background: #444;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .result-box {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--dark-bg);
            border: 1px solid rgba(0, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 50px;
            font-size: 0.9em;
            color: var(--text-light);
            word-wrap: break-word;
        }

        .placeholder-text {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }
        
        .loading-text {
            color: var(--accent-secondary);
            text-align: center;
            font-weight: 600;
        }

        .result-source {
            margin-top: 10px;
            border-top: 1px dashed rgba(0, 255, 255, 0.2);
            padding-top: 5px;
            font-size: 0.75em;
            color: #888;
        }

        .result-source a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color 0.2s;
        }
        .result-source a:hover {
            color: var(--accent-secondary);
        }
        
        /* === PHẦN PHẢN HỒI (FEEDBACK) === */
        .feedback-card {
            background-color: var(--card-color);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.1);
            width: 100%;
            margin-top: 20px;
        }

        .feedback-card h2 {
            color: var(--accent-secondary);
            text-shadow: 0 0 5px var(--accent-secondary);
            font-size: 1.5em;
            margin: 0 0 15px 0;
            text-align: center;
            text-transform: uppercase;
        }

        .feedback-card input, .feedback-card textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 51, 204, 0.5);
            background-color: var(--dark-bg);
            color: var(--text-light);
            border-radius: 6px;
            box-sizing: border-box;
            font-family: var(--font-family);
            outline: none;
        }
        .feedback-card input:focus, .feedback-card textarea:focus {
            border-color: var(--accent-secondary);
            box-shadow: 0 0 5px var(--accent-secondary);
        }

        .feedback-card textarea {
            resize: vertical;
            min-height: 60px;
        }

        .feedback-card button[type="submit"] {
            width: 100%;
            padding: 12px;
            background: var(--accent-secondary);
            color: var(--dark-bg);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            margin-bottom: 15px;
        }

        .feedback-card button[type="submit"]:hover {
            background: var(--accent-primary);
            box-shadow: 0 0 15px var(--accent-primary);
        }

        .feedback-list-title {
            color: var(--accent-primary);
            text-shadow: 0 0 3px var(--accent-primary);
            font-size: 1.1em;
            margin: 20px 0 15px;
            padding-top: 10px;
            border-top: 1px dashed rgba(255, 51, 204, 0.3);
            text-align: center;
        }

        #feedbackList {
            max-height: 250px;
            overflow-y: auto;
            padding: 0 5px;
        }
        
        /* Style cho từng phản hồi */
        .comment-item {
            background-color: var(--dark-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: left;
            border-left: 3px solid var(--accent-secondary);
            word-wrap: break-word; 
        }

        .comment-name {
            font-weight: 700;
            color: var(--accent-primary);
            margin: 0;
            font-size: 0.9em;
        }

        .comment-message {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: var(--text-light);
        }

        .comment-time {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 5px;
            text-align: right;
        }
        
        #userIdDisplay {
            font-size: 0.7em;
            color: #6c757d;
            margin-top: 15px;
            text-align: center;
        }
        
        /* Media Query cho di động */
        @media (max-width: 600px) {
            .profile-card, .feedback-card {
                padding: 25px 15px;
                margin: 0;
            }
            #main-wrapper {
                padding: 15px 0;
            }
        }

    </style>
    <!-- Thư viện Font Awesome cho icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
</head>
<body>

    <div id="main-wrapper">
        <div class="profile-card">
            <!-- Logo Trường -->
            <img src="uploaded:image_d1a85f.png-d13814bc-f6cf-49cb-bbe8-f4195e387567" alt="Logo Trường THPT Trần Phú"> 

            <!-- Tên -->
            <div class="name-container">
                <h1>NGÔ TRẦN QUỐC DUY</h1>
            </div>

            <!-- Thông tin cơ bản -->
            <div class="details">
                <p><strong>Ngày sinh:</strong> 04/09/2008 | <strong>Giới tính:</strong> Nam</p>
                <p><strong>Trường:</strong> THPT Trần Phú, TP.HCM</p>
            </div>
            
            <!-- Sở thích -->
            <div class="hobbies">
                <i class="fas fa-video"></i> Xem phim & <i class="fas fa-music"></i> Nghe nhạc
            </div>
            
            <!-- Mục tiêu -->
            <div class="goals-section">
                <h2>Mục tiêu Học tập</h2>
                <div class="goal-badges">
                    <div class="goal-badge" data-goal="Tốt nghiệp giỏi">
                        <i class="fas fa-medal"></i> Tốt nghiệp THPT loại giỏi
                    </div>
                    <div class="goal-badge dream-uni" data-goal="Đậu Đại học">
                        <i class="fas fa-graduation-cap"></i> Đậu vào Trường mơ ước
                    </div>
                </div>
            </div>

            <!-- LLM Integration - Goal Assistant -->
            <div class="llm-assistant-section">
                <h2>✨ Trợ lý Mục tiêu Gemini</h2>
                <textarea id="goalQuery" placeholder="Ví dụ: 'Làm thế nào để cải thiện điểm môn Toán?' hoặc 'Ngành IT có triển vọng gì?'"></textarea>
                <button id="askGeminiBtn" class="ask-button">
                    <i class="fas fa-magic"></i> Hỏi Gemini
                </button>
                <div id="geminiResult" class="result-box">
                    <p class="placeholder-text">Nhận lời khuyên từ AI để đạt được mục tiêu học tập!</p>
                </div>
            </div>

            <!-- Nút Liên hệ -->
            <a href="https://www.facebook.com/share/1DH3a3shJy/" class="social-button" target="_blank" rel="noopener noreferrer">
                <i class="fab fa-facebook-f"></i> KẾT NỐI VỚI MÌNH
            </a>
            
        </div>
        
        <!-- PHẦN PHẢN HỒI -->
        <div class="feedback-card">
            <h2><i class="fas fa-comment-dots"></i> Sổ Lưu Bút</h2>
            <form id="feedbackForm">
                <input type="text" id="feedbackName" placeholder="Tên của bạn (Tùy chọn)">
                <textarea id="feedbackMessage" placeholder="Lời nhắn muốn gửi (Tối đa 200 ký tự)..." required maxlength="200"></textarea>
                <button type="submit">Gửi Phản Hồi</button>
            </form>
            
            <h3 class="feedback-list-title">Lời Nhắn Mới Nhất</h3>
            <div id="feedbackList">
                <p style="text-align: center; color: #6c757d; font-size: 0.9em;">Đang kết nối và tải lời nhắn...</p>
            </div>
            <p id="userIdDisplay">ID Người Dùng: <span id="currentUserId">...</span></p>
        </div>
    </div>

    <!-- FIREBASE VÀ JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Thiết lập biến toàn cục
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Khởi tạo Firebase
        if (firebaseConfig) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            const auth = getAuth(app);
            let userId = null;

            // DOM elements
            const feedbackForm = document.getElementById('feedbackForm');
            const feedbackList = document.getElementById('feedbackList');
            const userIdSpan = document.getElementById('currentUserId');

            // LLM API Configuration
            const apiKey = ""; 
            const LLM_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";

            // DOM elements cho LLM
            const goalQueryInput = document.getElementById('goalQuery');
            const askGeminiBtn = document.getElementById('askGeminiBtn');
            const geminiResultDiv = document.getElementById('geminiResult');
            
            // Hàm định dạng thời gian
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'Vừa gửi';
                const date = timestamp.toDate();
                return date.toLocaleString('vi-VN', { 
                    day: '2-digit', month: '2-digit', year: 'numeric', 
                    hour: '2-digit', minute: '2-digit' 
                });
            };

            // Hàm kết nối và xử lý xác thực
            const setupAuthAndFirestore = async () => {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                    } else {
                        // Trường hợp không có user, dùng ID ngẫu nhiên cho mục đích hiển thị
                        userId = crypto.randomUUID(); 
                    }
                    userIdSpan.textContent = userId;
                    
                    // Chỉ khởi tạo listener sau khi có userId
                    if (userId) {
                        setupFeedbackListener(db, appId);
                    }
                });
            };
            
            // Thiết lập Listener theo thời gian thực (onSnapshot)
            const setupFeedbackListener = (db, appId) => {
                // Đường dẫn công khai (public) để mọi người đều có thể thấy
                const feedbackCollectionRef = collection(db, `artifacts/${appId}/public/data/user_feedback`);
                // LƯU Ý: ĐÃ XÓA orderBy() để tránh lỗi chỉ mục (index missing) theo hướng dẫn.
                const q = query(feedbackCollectionRef); 

                onSnapshot(q, (snapshot) => {
                    let messages = [];
                    snapshot.docs.forEach(doc => {
                        messages.push(doc.data());
                    });
                    
                    // Sắp xếp trong bộ nhớ (client-side) để tránh lỗi index missing
                    messages.sort((a, b) => {
                        // Đảm bảo các đối tượng có timestamp trước khi so sánh
                        const timeA = a.timestamp ? a.timestamp.toMillis() : 0;
                        const timeB = b.timestamp ? b.timestamp.toMillis() : 0;
                        return timeB - timeA; // Gần nhất lên đầu
                    });


                    feedbackList.innerHTML = ''; // Xóa nội dung cũ
                    if (messages.length === 0) {
                        feedbackList.innerHTML = `<p style="text-align: center; color: #6c757d; font-size: 0.9em;">Chưa có lời nhắn nào. Hãy là người đầu tiên!</p>`;
                        return;
                    }

                    messages.forEach(data => {
                        const item = document.createElement('div');
                        item.classList.add('comment-item');
                        
                        // Hiển thị tên người gửi (hoặc ID) và nội dung
                        const displayName = data.name || `Khách ẩn danh (${data.senderId.substring(0, 5)}...)`;
                        const timeString = formatTimestamp(data.timestamp);

                        item.innerHTML = `
                            <p class="comment-name"><i class="fas fa-user-circle"></i> ${displayName}</p>
                            <p class="comment-message">${data.message}</p>
                            <p class="comment-time">${timeString}</p>
                        `;
                        feedbackList.appendChild(item);
                    });
                }, (error) => {
                    console.error("Firestore Listener Error:", error);
                    feedbackList.innerHTML = `<p style="text-align: center; color: red;">Lỗi tải lời nhắn: ${error.code}</p>`;
                });
            };

            // Xử lý Gửi phản hồi
            feedbackForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nameInput = document.getElementById('feedbackName');
                const messageInput = document.getElementById('feedbackMessage');

                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (!message) return;

                const submitButton = feedbackForm.querySelector('button');
                submitButton.textContent = 'Đang gửi...';
                submitButton.disabled = true;

                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/user_feedback`), {
                        name: name.substring(0, 50) || null,
                        message: message.substring(0, 200),
                        timestamp: serverTimestamp(),
                        senderId: userId,
                    });

                    // Xóa form sau khi gửi thành công
                    nameInput.value = '';
                    messageInput.value = '';

                } catch (e) {
                    console.error("Error adding document: ", e);
                } finally {
                    submitButton.textContent = 'Gửi Phản Hồi';
                    submitButton.disabled = false;
                }
            });

            // 1. Logic cho Goal Badge
            const goalBadges = document.querySelectorAll('.goal-badge');
            const originalGoal = document.querySelector('.goals-section h2').textContent;
            const goalsTitle = document.querySelector('.goals-section h2');

            goalBadges.forEach(badge => {
                badge.addEventListener('click', () => {
                    goalBadges.forEach(b => {
                        if (b !== badge) {
                            b.classList.remove('clicked');
                        }
                    });
                    badge.classList.toggle('clicked');
                    
                    if (badge.classList.contains('clicked')) {
                         goalsTitle.textContent = `💪 Đang tập trung vào: ${badge.dataset.goal}`;
                    } else {
                         goalsTitle.textContent = originalGoal;
                    }
                });
            });


            /**
             * Thực hiện gọi API Gemini với logic retry (exponential backoff).
             * @param {Object} payload - Payload cho API.
             * @param {number} retries - Số lần thử lại tối đa.
             * @returns {Promise<Object>} Kết quả JSON từ API.
             */
            const callGeminiApiWithRetry = async (payload, retries = 5) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(`${LLM_API_URL}?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            return await response.json();
                        } else if (response.status === 429) { 
                            // Quá giới hạn tốc độ (Rate Limit)
                            if (i < retries - 1) {
                                const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue; 
                            }
                            throw new Error("Lỗi giới hạn tốc độ API sau nhiều lần thử.");
                        } else {
                            // Lỗi khác
                            const errorBody = await response.text();
                            throw new Error(`Lỗi API: ${response.status} - ${errorBody}`);
                        }
                    } catch (error) {
                        if (i === retries - 1) {
                            throw error; // Ném lỗi nếu đã thử hết
                        }
                        // Retry logic (đã xử lý ở trên)
                    }
                }
            };

            // Xử lý nút Hỏi Gemini
            askGeminiBtn.addEventListener('click', async () => {
                const query = goalQueryInput.value.trim();
                if (!query) {
                    geminiResultDiv.innerHTML = `<p class="placeholder-text">Vui lòng nhập câu hỏi của bạn.</p>`;
                    return;
                }

                askGeminiBtn.disabled = true;
                askGeminiBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang phân tích...';
                geminiResultDiv.innerHTML = `<p class="loading-text">Gemini đang tìm kiếm lời khuyên tốt nhất...</p>`;

                const systemPrompt = "Bạn là một cố vấn học tập và hướng nghiệp thân thiện, nhiệt tình ở Việt Nam. Hãy đưa ra câu trả lời ngắn gọn (dưới 150 từ), trực tiếp, và dựa trên thông tin thực tế cho học sinh cấp 3. Sử dụng tiếng Việt chuẩn.";

                const payload = {
                    contents: [{ parts: [{ text: query }] }],
                    // Kích hoạt Google Search để có thông tin cập nhật (về trường, ngành, điểm số)
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                try {
                    const result = await callGeminiApiWithRetry(payload);
                    const candidate = result.candidates?.[0];
                    let text = "Không thể tìm thấy câu trả lời phù hợp. Vui lòng thử lại.";
                    let sourcesHtml = "";
                    
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        text = candidate.content.parts[0].text;

                        // Xử lý trích dẫn nguồn (citations)
                        const groundingMetadata = candidate.groundingMetadata;
                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            const sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title);

                            if (sources.length > 0) {
                                sourcesHtml = '<div class="result-source">Nguồn tham khảo:';
                                sources.slice(0, 3).forEach((source, index) => { // Chỉ lấy 3 nguồn đầu
                                    sourcesHtml += `<br><a href="${source.uri}" target="_blank" rel="noopener noreferrer">${index + 1}. ${source.title.substring(0, 50)}...</a>`;
                                });
                                sourcesHtml += '</div>';
                            }
                        }
                    }

                    geminiResultDiv.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>${sourcesHtml}`;

                } catch (error) {
                    console.error("Lỗi Gemini API:", error);
                    geminiResultDiv.innerHTML = `<p style="color: var(--accent-primary); text-align: center;">Lỗi kết nối. Vui lòng kiểm tra console hoặc thử lại.</p>`;
                } finally {
                    askGeminiBtn.disabled = false;
                    askGeminiBtn.innerHTML = '<i class="fas fa-magic"></i> Hỏi Gemini';
                }
            });


            // Bắt đầu quá trình xác thực và tải dữ liệu
            setupAuthAndFirestore();

        } else {
            console.error("Firebase config is missing!");
            document.getElementById('feedbackList').innerHTML = '<p style="text-align: center; color: red;">Lỗi: Không thể kết nối dịch vụ lưu trữ.</p>';
        }

    </script>
</body>
</html>
